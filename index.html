<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 BLE Controller</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body {
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container text-center">
        <h1>ESP32 BLE Controller</h1>
        <p id="status">Status: Disconnected</p>
        <button id="connect" class="btn btn-primary">Connect</button>

        <div id="controls" style="display:none;">
            <h3>LED Controls</h3>
            <button id="ledOn" class="btn btn-success">Turn On LEDs</button>
            <button id="ledOff" class="btn btn-danger">Turn Off LEDs</button>
            <div class="mt-3">
                <label for="colorPicker" class="form-label">Pick a Color:</label>
                <input type="color" id="colorPicker" class="form-control form-control-color" value="#ffffff" title="Choose your color">
                <button id="setColor" class="btn btn-info mt-2">Set Color</button>
            </div>
            <h3 class="mt-4">OTA Update</h3>
            <input type="file" id="firmwareFile" class="form-control mb-3">
            <button id="uploadFirmware" class="btn btn-warning">Upload Firmware</button>
        </div>
    </div>

    <script>
        let device, server, ledCharacteristic, otaCharacteristic;

        document.getElementById("connect").addEventListener("click", async () => {
            try {
                device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: ["19b10000-e8f2-537e-4f6c-d104768a1214"]
                });
                server = await device.gatt.connect();
                const service = await server.getPrimaryService("19b10000-e8f2-537e-4f6c-d104768a1214");
                ledCharacteristic = await service.getCharacteristic("19b10002-e8f2-537e-4f6c-d104768a1214");
                otaCharacteristic = await service.getCharacteristic("19b10003-e8f2-537e-4f6c-d104768a1214");

                document.getElementById("status").textContent = "Status: Connected";
                document.getElementById("controls").style.display = "block";

                device.addEventListener("gattserverdisconnected", () => {
                    document.getElementById("status").textContent = "Status: Disconnected";
                    document.getElementById("controls").style.display = "none";
                });
            } catch (error) {
                console.error("Error:", error);
            }
        });

        document.getElementById("ledOn").addEventListener("click", () => {
            ledCharacteristic.writeValue(new Uint8Array([1]));
        });

        document.getElementById("ledOff").addEventListener("click", () => {
            ledCharacteristic.writeValue(new Uint8Array([0]));
        });

        document.getElementById("setColor").addEventListener("click", () => {
            const color = document.getElementById("colorPicker").value;
            const r = parseInt(color.substring(1, 3), 16);
            const g = parseInt(color.substring(3, 5), 16);
            const b = parseInt(color.substring(5, 7), 16);

            // Send 'C' + R + G + B to the BLE device
            ledCharacteristic.writeValue(new Uint8Array(['C'.charCodeAt(0), r, g, b]));
        });

        document.getElementById("uploadFirmware").addEventListener("click", async () => {
            const fileInput = document.getElementById("firmwareFile");
            if (fileInput.files.length === 0) {
                alert("Please select a firmware file.");
                return;
            }

            const file = fileInput.files[0];
            const chunkSize = 512;
            const fileBuffer = await file.arrayBuffer();
            const totalChunks = Math.ceil(fileBuffer.byteLength / chunkSize);

            for (let i = 0; i < totalChunks; i++) {
                const chunk = fileBuffer.slice(i * chunkSize, (i + 1) * chunkSize);
                await otaCharacteristic.writeValue(new Uint8Array(chunk));
            }

            alert("Firmware upload completed!");
        });
    </script>
</body>
</html>
