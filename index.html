<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 BLE Controller</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body {
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container text-center">
        <h1>ESP32 BLE Controller</h1>
        <p id="status">Status: Disconnected</p>
        <button id="connect" class="btn btn-primary">Connect</button>

        <div id="controls" style="display:none;">
            <h3>LED Controls</h3>
            <button id="ledOn" class="btn btn-success">Turn On LEDs</button>
            <button id="ledOff" class="btn btn-danger">Turn Off LEDs</button>
            <div class="mt-3">
                <label for="colorPicker" class="form-label">Pick a Color:</label>
                <input type="color" id="colorPicker" class="form-control form-control-color" value="#ffffff" title="Choose your color">
                <button id="setColor" class="btn btn-info mt-2">Set Color</button>
            </div>
            <h3 class="mt-4">OTA Update</h3>
            <input type="file" id="firmwareFile" class="form-control mb-3">
            <button id="uploadFirmware" class="btn btn-warning">Upload Firmware</button>
        </div>
    </div>

    <script>
        let device, server, ledCharacteristic, otaCharacteristic;
        const statusElement = document.getElementById("status");
        const connectButton = document.getElementById("connect");
        const controls = document.getElementById("controls");
        const ledOnButton = document.getElementById("ledOn");
        const ledOffButton = document.getElementById("ledOff");
        const colorPicker = document.getElementById("colorPicker");
        const colorPreview = document.getElementById("colorPreview");
        const brightnessSlider = document.getElementById("brightness");
        const firmwareFileInput = document.getElementById("firmwareFile");
        const uploadFirmwareButton = document.getElementById("uploadFirmware");
    
        async function connectBLE() {
            try {
                statusElement.textContent = "Status: Connecting...";
                device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: ["19b10000-e8f2-537e-4f6c-d104768a1214", "19b10000-e8f2-537e-4f6c-d104768a1215"] // Include OTA service UUID
                });
                server = await device.gatt.connect();
                const ledService = await server.getPrimaryService("19b10000-e8f2-537e-4f6c-d104768a1214");
                ledCharacteristic = await ledService.getCharacteristic("19b10002-e8f2-537e-4f6c-d104768a1214");
                const otaService = await server.getPrimaryService("19b10000-e8f2-537e-4f6c-d104768a1215");
                otaCharacteristic = await otaService.getCharacteristic("19b10002-e8f2-537e-4f6c-d104768a1215");
    
                statusElement.textContent = "Status: Connected";
                controls.style.display = "block";
    
                device.addEventListener("gattserverdisconnected", () => {
                    statusElement.textContent = "Status: Disconnected";
                    controls.style.display = "none";
                });
            } catch (error) {
                console.error("Error connecting to BLE device:", error);
                statusElement.textContent = "Status: Error Connecting";
            }
        }
    
        async function sendCommand(command) {
            if (!ledCharacteristic) return;
            await ledCharacteristic.writeValue(new Uint8Array(command));
        }
    
        async function uploadFirmware() {
            const file = firmwareFileInput.files[0];
            if (!file) {
                alert("Please select a firmware file.");
                return;
            }
    
            try {
                statusElement.textContent = "Status: Uploading Firmware...";
                const chunkSize = 512; // BLE MTU size
                const firmware = await file.arrayBuffer();
                const totalChunks = Math.ceil(firmware.byteLength / chunkSize);
                const firmwareView = new Uint8Array(firmware);
    
                for (let i = 0; i < totalChunks; i++) {
                    const chunk = firmwareView.slice(i * chunkSize, (i + 1) * chunkSize);
                    await otaCharacteristic.writeValue(chunk);
                    console.log(`Chunk ${i + 1}/${totalChunks} uploaded`);
                }
    
                statusElement.textContent = "Status: Firmware Upload Complete";
            } catch (error) {
                console.error("Error uploading firmware:", error);
                statusElement.textContent = "Status: Firmware Upload Failed";
            }
        }
    
        connectButton.addEventListener("click", connectBLE);
        ledOnButton.addEventListener("click", () => sendCommand([1]));
        ledOffButton.addEventListener("click", () => sendCommand([0]));
    
        colorPicker.addEventListener("input", (event) => {
            const color = event.target.value;
            colorPreview.style.backgroundColor = color;
            const r = parseInt(color.substr(1, 2), 16);
            const g = parseInt(color.substr(3, 2), 16);
            const b = parseInt(color.substr(5, 2), 16);
            sendCommand([67, r, g, b]); // 'C' command followed by RGB values
        });
    
        brightnessSlider.addEventListener("input", (event) => {
            const brightness = parseInt(event.target.value);
            console.log(`Brightness set to: ${brightness}`);
            // Implement brightness adjustment on the ESP32 side if supported.
        });
    
        uploadFirmwareButton.addEventListener("click", uploadFirmware);
    </script>
</body>
</html>
